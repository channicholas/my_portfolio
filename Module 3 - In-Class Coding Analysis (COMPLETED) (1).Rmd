---
title: "Module 3 - Simple Linear Regression Model Inference"
subtitle: <center> <h1>In-Class Analysis</h1> </center>
output: html_document
---

<style type="text/css">
h1.title {
  font-size: 40px;
  text-align: center;
}
</style>

```{r setup, include=FALSE}
# load packages here
library(tidyverse)
```

## Data and Description

Energy can be produced from wind using windmills. Choosing a site for a wind farm (i.e. the location of the windmills), however, can be a multi-million dollar gamble. If wind is inadequate at the site, then the energy produced over the lifetime of the wind farm can be much less than the cost of building the operation. Hence, accurate prediction of wind speed at a candidate site can be an important component in the decision to build or not to build. Since energy produced varies as the square of the wind speed, even small errors in prediction can have serious consequences.

One possible solution to help predict wind speed at a candidate site is to use wind speed at a nearby reference site. A reference site is a nearby location where the wind speed is already being monitored and should, theoretically, be similar to the candidate site. Using information from the reference site will allow windmill companies to know the wind speed at the candidate site without going through a costly data collection period, if the reference site is a good predictor. 

The Windmill data set contains measurements of wind speed (in meters per second m/s) at a **candidate site (CSpd) (column 1)** and at an accompanying **reference site (RSpd) (column 2)** for 1,116 areas. Download the Windmill.txt file from Canvas, and put it in the same folder as this R Markdown file.

Do the following:

1. Read in the data set, assign it to a variable `wind`, and take a look at the top 15 rows.
2. Create a scatterplot of the data, and overlay the fitted linear regression line.
3. Apply linear regression to the data with `CSpd` as response and `RSpd` as predictor.
4. Save the model fit as a variable, and save the residuals and fitted values to the `wind` data frame.
5. Examine the summary of the model fit using the `summary` function. (For help on this function, type `?summary.lm` in your R console.)

```{r}
wind <- read.csv(file = "Windmill.txt", header = TRUE, sep = "")
wind.base.plot <- ggplot(data = wind, aes(x = RSpd, y = CSpd)) + 
  geom_point(size = 0.3) + 
  labs(title = 'Scatterplot of Windspeeds', x = 'Ref. Site Wind Speed (m/s)', 
       y = 'Cand. Site Wind Speed (m/s)') 
wind.base.plot + geom_smooth(method = 'lm', color = 'blue', se = FALSE)

windlm <- lm(CSpd ~ RSpd, data = wind)
wind$residuals <- windlm$residuals
wind$fitted.values <- windlm$fitted.values

summary(windlm)
```

## Statistical Inference for the Slope

#### Using the formula from class, compute $\mathrm{SE}(\hat{\beta}_1)$, the standard error of the OLS estimator for the slope.  Check your answer by comparing with the standard error reported in the summary above.

```{r}
RSS <- sum(wind$residuals^2)
sigSqHat <- RSS/(nrow(wind) - 2)
Sxx <- with(wind, sum((RSpd - mean(RSpd))^2))
SEb1 <- sqrt(sigSqHat/Sxx)
```

The value $\mathrm{SE}(\hat{\beta}_1) = $ `r round(SEb1, 3)` matches the value from the summary output above.

#### Use the `confint` R function to create a 99% confidence interval for the slope. How would you interpret this interval?  What would you expect to change about this interval if the level was changed to 90%, and why?
 
```{r}
# Uncomment the code below to generate the CI. You must replace my.lm.var with
# the name of the variable to which you assigned the linear model fit
# If you remove 'par = 2', you will get CIs for the intercept and slope instead
# of just the slope.


CIslope99 <- round(confint(windlm, par = 2, level = 0.99), 2)
CIslope99
```

We are 99\% confident that the change in average wind speed at the candidate site will be between 0.71 and 0.81 m/s when the wind speed at the reference site increases by 1 m/s.  The interval would shrink somewhat if the level was changed to 90%.  Intuitively, this happens because we are imposing a lower level of confidence.  Mathematically, the t-percentile in the CI formula would decrease, which would then decrease the length of the interval.

#### Use the fitted model and the R function `pt` to conduct a hypothesis test on the slope. The test statistic and p-value you obtain should match those in the output from `summary`. *Note that the `summary` output results from a two-sided test. Use `?pt` if you are not sure what this function does.

```{r}
tstat <- windlm$coefficients[2]/SEb1
pval <- 2*pt(abs(tstat), df = nrow(wind) - 2, lower.tail = FALSE)
pval
```

The p-value is extremely small, so we reject the null hypothesis and conclude that the average wind speed at the candidate site is different for reference sites with different wind speeds.

## Statistical Inference for the Mean Response

#### Using the `predict` function, calculate a 90% confidence interval for the average wind speed at the candidate site when the measured wind speed at the reference site is 8 m/s. 
```{r}
# Uncomment the code below to create the CI, again replacing my.lm.var with the 
# appropriate variable name
CI90x8 <- round(predict(windlm, newdata = data.frame(RSpd = 8), interval = 'confidence'), 4)
CI90x8
```

#### Create a confidence band for all average wind speeds at hypothetical candidate sites corresponding to all reference site wind speeds within the range of the data.

```{r}
# If wind.base.plot is your base scatterplot of wind speeds (not including the 
# fitted regression line), the following code will produce the desired plot

 wind.base.plot + geom_smooth(method = 'lm', se = TRUE)
```

## Statistical Inference for the Individual Observations

#### Using the `predict` function, calculate an 90% prediction interval for the wind speed at a future candidate site when the wind speed at the reference cite is 8 m/s. Explain why, even though the level is the same as the level used above for the confidence interval of the mean response, the prediction interval is much wider.
```{r}
PI90x8 <- round(predict(windlm, newdata = data.frame(RSpd = 8), interval = 'predict'), 4)
PI90x8
```

The interval is wider because it is for a single measurement of wind speed at the candidate site, as opposed to the average wind speed.

#### Using the `predict` function with a data frame of many $x$ values (use the `seq` R function starting at the minimum of `RSpd` and going to the maximum of `RSpd`), create a prediction band for candidate site wind speeds across all values of reference site wind speeds. Overlay this prediction band on your previous scatterplot using the `geom_line` function twice.

```{r}
# The code below will generate the desired band
#
RSpd_grid <- with(wind, seq(min(RSpd), max(RSpd), length.out = 101))
windPB <- with(as.data.frame(predict(windlm, level = 0.9, 
                                                      newdata = data.frame(RSpd = RSpd_grid), 
                                                      interval = "prediction")), 
                                data.frame(RSpd = RSpd_grid, CSpd = fit, 
                                           lwr = lwr, upr = upr))
names(windPB) = c("RSpd", "CSpd", "lwr", "upr")

wind.base.plot + geom_ribbon(data = windPB, aes(ymin = lwr, ymax = upr),
                     alpha = 0.5, outline.type = 'both')
```


## ANOVA for Regression

#### Using only the model summary output above (i.e., without using the `anova` function), complete the first four columns of the ANOVA table for your fitted linear regression model below (places with a `?` should be replaced by your answer).  __Once you are finished, use R to construct the ANOVA table and verify your calculations__.

Source        | Degrees of Freedom | Sum of Squares | Mean Square
------------- | ------------------ | -------------- | -----------
RSpd          |            1       |     9015.6     |   9015.6
Residual      |         1113       |     6775.75    |      6.1
Total         |         1115       |    15791.34    |   


#### Calculate the variance estimate $\hat{\sigma}^2$ using the values from the ANOVA table above.

```{r}
sigHatSq <- 6775.76/1113
```

#### Calculate R-Squared (Coefficient of Determination) using the values from the ANOVA table above. The value you get should match the value from the `summary` function you used above.

```{r}
Rsq <- 1 - 6775.75/15791.34
```

#### Recall that the total sum of squares (TSS, also called $S_{YY}$) is $\sum_{i = 1}^n (Y_i - \overline{Y})^2.$  Using the fitted model, verify that
$$
RSS = S_{YY}(1 - R^2).
$$
Since $S_{YY}$ is the total variability in the $Y_i$s, and $RSS$ is the variability left in the residuals _after_ regression is performed, $R^2$ can be interpreted as the __proportion of variability in the response explained by a linear relationship with the response__.
```{r}
RSS
15791.34*(1 - Rsq)
```

