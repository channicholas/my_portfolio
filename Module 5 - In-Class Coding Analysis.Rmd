---
title: "Module 5 - ANCOVA and Transformations"
subtitle: <center> <h1>In-Class Analysis</h1> </center>
output: html_document
---

<style type="text/css">
h1.title {
  font-size: 40px;
  text-align: center;
}
</style>

```{r setup, include=FALSE}
# load packages here
library(tidyverse)
library(ggfortify)  # plot lm objects using ggplot instead of base R
library(alr4)  # UN11 data - also loads car
library(gridExtra) # for grid.arrange()
```

## Data and Description

Macroeconomists often speculate that life expectancy is linked with the economic well-being of a country. Macroeconomists also hypothesize that Organisation for Economic Co-operation and Development (OECD) (an international think tank charged with promoting policies that will improve global social and economic well-being) members will have longer life expectancy. To test these hypotheses, you will analyze the `UN11` data set used extensively in lecture.  Specifically, you will replicate some of the analyses from the lecture examples (and execute some new ones)  to help solidify the concepts from Module 5.  

When you load the `alr4` library, the `UN11` data is automatically loaded along with it, so there is no need to read in any data.

## Fitting an ANOVA model with `lm`

### Fit a multiple linear regression model with `lifeExpF` as the response and `group` as the predictor.  Call the model `group.lm`.

```{r}
group.lm <- lm(lifeExpF ~ group, data = UN11)
summary(group.lm)
```

#### Explain why, even though `group` is a single variable (i.e. it is contained in just one column of the `UN11` data frame), this is NOT a simple linear regression model.

Since `group` contains 3 categories, it is represented by two different dummy variables in the regression model.  Hence, there are two regressors, making it a multiple linear regression model.

#### Use the OLS coefficient estimates from your fitted model to compute the estimated mean response for each level of `group`.  Verify that these are equal to the sample means within each group.


```{r}
# Hint 1: group.lm$coefficients[1] is the estimated intercept, and represents the estimated mean response for the default (oecd) group
# Hint 2: mean(UN11$lifeExpF[UN11$group == 'oecd']) will compute the sample mean of lifeExpF within the oecd group
groupMeans <- c(group.lm$coefficients[1], group.lm$coefficients[1] + group.lm$coefficients[2], group.lm$coefficients[1] + group.lm$coefficients[3])
groupMeans
c(mean(UN11$lifeExpF[UN11$group == 'oecd']), mean(UN11$lifeExpF[UN11$group == 'other']), mean(UN11$lifeExpF[UN11$group == 'africa']))
```

### Fit the same model as above using dummy variables (still with `oecd` as the default group).  Call the model `groupDV.lm` and verify that the coefficient estimates are the same.

```{r}
# your code here
# Hint: The code below will create a dummy variable for the African nations 
# 
UN11$africaDV <- (UN11$group == 'africa')
UN11$oecdDV <- (UN11$group == 'oecd')
UN11$otherDV <- (UN11$group == 'other')

groupDV.lm <- lm(lifeExpF ~ otherDV + africaDV, data = UN11)
groupDV.lm$coefficients
group.lm$coefficients
```

#### Switch the default group to be `other` by excluding its dummy variable in the model rather than excluding the dummy variable for `oecd`.  Call the model `groupDV2.lm` and verify that the estimated intercept gives the sample mean for `other` nations computed above.

```{r}
groupDV2.lm <- lm(lifeExpF ~ oecdDV + africaDV, data = UN11)
groupDV2.lm$coefficients[1]
groupMeans[2]
```

#### Note: Another way to change the default group without using dummy variable is to rearrange the levels of a factor.  Uncomment and run the code below to verify that it produces the same estimates as your model above.

```{r}
UN11$groupOth <- factor(UN11$group, levels = c("other", "oecd", "africa"))
groupOth.lm <- lm(lifeExpF ~ groupOth, data = UN11)
summary(groupOth.lm)
```


## Analysis of Covariance

### Produce a scatterplot of life expectancy for females versus per capita GDP, with the latter on the log scale.  Use different colors and shapes to represent different groups.

```{r}
# Hint: When specifying the `mapping' variable in geom_point(), add the arguments `shape = group' and `color = group' within the aes() function
ggplot(data = UN11, mapping = aes(x = log(ppgdp), y = lifeExpF, 
                                  color = group, shape = group)) +
  geom_point() +
  labs(title = "Life Expectancy vs. log(ppgdp) by Group",
       x = "Per Capita GDP (US dollars, log scale)", 
       y = "Life Expectancy of Females (years)")
```

### Fit the ANCOVA (analysis of covariance or parallel) model that adjusts for both `group` and `log(ppgdp)`

```{r}
par.lm <- lm(lifeExpF ~ group + log(ppgdp), data = UN11)
summary(par.lm)
```

#### Add the estimated group mean functions to your scatterplot, with different line colors for each group.

```{r}
UN11$parFit <- par.lm$fitted.values
parPlot <- ggplot(data = UN11, mapping = aes(x = log(ppgdp), y = lifeExpF, 
                                  color = group, shape = group)) +
  geom_point() +
  geom_line(aes(x = log(ppgdp), y = parFit, color = group)) +
  labs(title = "Life Expectancy vs. log(ppgdp) by Group",
       x = "Per Capita GDP (US dollars, log scale)", 
       y = "Life Expectancy of Females (years)")
parPlot
```

#### What is the meaning of the coefficient corresponding to `groupafrica`?

It means that the average life expectancy for females of an African nation will be 12.17 years less than an OECD nation, if the two share the same per capita GDP.

#### How would you interpret the coefficient for `log(ppgdp)`?

It means that, for countries in the same group, a 10% increase in `ppgdp` will result in a `r round(par.lm$coefficient[4]*log(1.1), 3)` year increase in the life expectancy of females.

### Is there is a difference in the average life expectancy for fewales between an African nation and an OECD nation, assuming these two nations have the same per capita GDP?  How do you know?

Yes, because the p-value corresponding to `groupAfrica` is significant, and corresponds to testing the null hypothesis that African and OECD nations with the same per capita GDP have the same life expectancy for females.

### Fit the nonparallel version of this ANCOVA model by introducing an interaction between the categorical and numeric variables.

```{r}
np.lm <- lm(lifeExpF ~ group*log(ppgdp), data = UN11)
summary(np.lm)
```

#### Add the new estimated group mean functions to the original scatterplot, with different line colors for each group.  Put this new plot side-by-side with the fitted values plot obtained above using the parallel model.

```{r fig.width=12}
UN11$npFit <- np.lm$fitted.values
npPlot <- ggplot(data = UN11, mapping = aes(x = log(ppgdp), y = lifeExpF, 
                                  color = group, shape = group)) +
  geom_point() +
  geom_line(aes(x = log(ppgdp), y = npFit, color = group)) +
  labs(title = "Life Expectancy vs. log(ppgdp) by Group",
       x = "Per Capita GDP (US dollars, log scale)", 
       y = "Life Expectancy of Females (years)")
grid.arrange(parPlot, npPlot, ncol = 2)
```

#### Test whether the parallel model is sufficient, or if the nonparallel model provides a statistically significant improvement.  Note that, if we write the nonparallel model as
$$
\texttt{lifeExpF}_i = \beta_0 + \beta_1\texttt{africaDV}_i + \beta_2\texttt{otherDV}_i + \beta_3\log(\texttt{ppgdp}_i) + \beta_{13}\texttt{africaDV}_i\log(\texttt{ppgdp}_i) + \beta_{23}\texttt{otherDV}_i\log(\texttt{ppgdp}_i) + \epsilon_i,
$$
testing whether the parallal (reduced) model is sufficient is equivalent to testing the hypotheses:
$$
\mathcal{H}_0: \beta_{13} = \beta_{23} = 0 \quad \text{vs.} \quad \mathcal{H}_A: \beta_{13} \neq 0 \text{ or } \beta_{23} \neq 0.
$$

```{r}
anova(par.lm, np.lm)
```

## Summary and Conclusions

Dummy variables are the key to incorporating categorical predictors into multiple linear regression models.  For a categorical variable with $k$ levels, we need $k-1$ dummy variables to fit the model.  The level that is not assigned a dummy variable is known as the "default" (or "baseline" or "control") group, and the coefficients corresponding to the dummy variables correspond to contrasts between the group they represent and this default group.  R handles dummy variables internally if we use a factor in the `formula` argument of `lm`, and we can control the order of the levels (and thus choose which level is treated as the default) using the `factor()` function.  When only categorical variables are present as predictors, the model is equivalent to an ANOVA model.

If other numeric predictors are present in addition to categorical predictors (with no interactions), the regression model is essentially fitting one multiple linear regression model for each set of fixed values of the categorical predictors, with the constraint that the slopes for the numeric predictors are always the same no matter what categories are chosen.   The coefficients for the dummy variables in the model then determine the intercept for each set of fixed categories.  This is often called a ``parallel" model since lines (or hyperplanes) with the same slope coefficients must be parallel to one another. By adding interactions between categorical and numeric variables, we can allow for different slopes between fixed sets of categories, resulting in a "nonparallel" model